{
  "workflow": {
    "unique_name": "definition_workflow_02P2TQOB7DX6K3gAgOuYpTjybvDO9rat6So",
    "name": "Pre Flight Check",
    "title": "Pre Flight Check",
    "type": "generic.workflow",
    "base_type": "workflow",
    "variables": [
      {
        "schema_id": "datatype.boolean",
        "properties": {
          "value": false,
          "scope": "output",
          "name": "Next Step",
          "type": "datatype.boolean",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false,
          "variable_string_format": ""
        },
        "unique_name": "variable_workflow_02SXTYY8AQAGT2NbeV2eGxFHZ1QU1qdOgfK",
        "object_type": "variable_workflow"
      },
      {
        "schema_id": "datatype.string",
        "properties": {
          "value": "",
          "scope": "output",
          "name": "Files to potentially delete",
          "type": "datatype.string",
          "is_required": false,
          "display_on_wizard": false,
          "is_invisible": false,
          "variable_string_format": ""
        },
        "unique_name": "variable_workflow_02P2UXFINIHWG1FsBmZu85dGEZ8558ActwC",
        "object_type": "variable_workflow"
      }
    ],
    "properties": {
      "atomic": {
        "is_atomic": false
      },
      "delete_workflow_instance": false,
      "display_name": "Pre Flight Check",
      "runtime_user": {
        "target_default": true
      },
      "target": {
        "target_type": "terminal.endpoint",
        "target_id": "definition_target_02SXP7C95Y9J56IqyjHnR9YXHNH0U2TzxXX",
        "execute_on_workflow_target": true
      }
    },
    "object_type": "definition_workflow",
    "actions": [
      {
        "unique_name": "definition_activity_02SYPDQ4Z5ZYL4v7ZhwYByNdc6RoaY1PTvL",
        "name": "Execute Terminal Command(s)",
        "title": "Get Version",
        "type": "terminal.command",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "command_timeout": 6,
          "commands": "term len 0\nsh ver\nsend log 6 \"PRE-FLIGHT: SHOW VERSION COMPLETE\"",
          "continue_on_failure": false,
          "description": "Executes commands on terminal target",
          "display_name": "Get Version",
          "merge_commands": false,
          "runtime_user": {
            "target_default": true
          },
          "skip_execution": false,
          "succeeded_expects": [
            "9300-2",
            "\"9300-2\"",
            ".*#$",
            "\"9300-2#\\n\""
          ],
          "target": {
            "use_workflow_target": true
          },
          "user_responses": []
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02P2U2T2QYUZH2hag9EbH6rPHxFq3mS1E3O",
        "name": "Execute Python Script",
        "title": "Pull Details",
        "type": "python3.script",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "continue_on_failure": false,
          "description": "Execute Python Script",
          "display_name": "Pull Details",
          "script": "import re\n\noutput = '''$activity.definition_activity_02SYPDQ4Z5ZYL4v7ZhwYByNdc6RoaY1PTvL.output.response_body$'''\n\n\ndef _first_match(patterns, text, flags=0):\n    for pattern in patterns:\n        match = re.search(pattern, text, flags)\n        if match:\n            return match.group(1).strip()\n    return \"\"\n\n\nversion = _first_match(\n    [\n        r\"Cisco IOS XE Software, Version\\s+([^\\n]+)\",\n        r\"Cisco IOS Software,\\s+Version\\s+([^\\s,]+)\",\n        r\"IOS\\s+\\([^\\)]+\\)\\s+Software,\\s+Version\\s+([^\\s,]+)\",\n        r\"Version\\s+([^\\s,]+)\",\n    ],\n    output,\n)\n\nmodel = _first_match(\n    [\n        r\"^cisco\\s+([^\\s]+)\\s*\\(\",\n        r\"Model Number\\s*:\\s*([^\\n]+)\",\n        r\"[Pp]latform\\s*:\\s*([^\\n]+)\",\n        r\"[Hh]ardware\\s*:\\s*([^,\\n]+)\",\n    ],\n    output,\n    flags=re.MULTILINE,\n)\n\nserial = _first_match(\n    [\n        r\"System Serial Number\\s*:\\s*([^\\n]+)\",\n        r\"Processor board ID\\s+([^\\n]+)\",\n        r\"[Ss]erial [Nn]umber\\s*:\\s*([^\\n]+)\",\n    ],\n    output,\n)",
          "script_queries": [
            {
              "script_query": "version",
              "script_query_name": "version",
              "script_query_type": "string"
            },
            {
              "script_query": "model",
              "script_query_name": "model",
              "script_query_type": "string"
            },
            {
              "script_query": "serial",
              "script_query_name": "serial",
              "script_query_type": "string"
            }
          ],
          "skip_execution": false
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02P2UD7LGQZH724WgYVnvYLd5gyZTkYtXXk",
        "name": "Execute Terminal Command(s)",
        "title": "Check flash space",
        "type": "terminal.command",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "command_timeout": 60,
          "commands": "term len 0\ndir flash:\ndir flash | inc .bin\nsend log 6 \"PRE-FLIGHT: CHECK SPACE COMPLETE\"",
          "continue_on_failure": false,
          "description": "Executes commands on terminal target",
          "display_name": "Check flash space",
          "merge_commands": false,
          "runtime_user": {
            "target_default": true
          },
          "skip_execution": false,
          "target": {
            "use_workflow_target": true
          },
          "user_responses": []
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02P2UE59JBJ8I4LpYhoREmr6uBPySVyV3nb",
        "name": "Execute Python Script",
        "title": "Pull Details",
        "type": "python3.script",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "continue_on_failure": false,
          "description": "Execute Python Script",
          "display_name": "Pull Details",
          "script": "import re\n\noutput = '''$activity.definition_activity_02P2UD7LGQZH724WgYVnvYLd5gyZTkYtXXk.output.response_body$'''\n\nfree_space = \"\"\n\npatterns = [\n    r\"bytes total \\((\\d+) bytes free\\)\",\n    r\"(\\d+) bytes free\",\n    r\"(\\d+)\\s+bytes\\s+available\",\n]\n\nfor pattern in patterns:\n    match = re.search(pattern, output)\n    if match:\n        free_space = match.group(1).strip()\n        break\n",
          "script_queries": [
            {
              "script_query": "free_space",
              "script_query_name": "free_space",
              "script_query_type": "string"
            }
          ],
          "skip_execution": false
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02P2UKEYQS5KE5dbRsEHZSFN3nfLjyQVI6Y",
        "name": "Execute Terminal Command(s)",
        "title": "check for .bin files",
        "type": "terminal.command",
        "base_type": "activity",
        "properties": {
          "action_timeout": 180,
          "command_timeout": 60,
          "commands": "term len 0\ndir flash: | inc .bin",
          "continue_on_failure": false,
          "description": "Executes commands on terminal target",
          "display_name": "check for .bin files",
          "merge_commands": false,
          "runtime_user": {
            "target_default": true
          },
          "skip_execution": false,
          "target": {
            "use_workflow_target": true
          }
        },
        "object_type": "definition_activity"
      },
      {
        "unique_name": "definition_activity_02P2UVAMRN4WA6Rv77Ih3jApY7RGQn3zwGa",
        "name": "Condition Block",
        "title": "Enough free flash?",
        "type": "logic.if_else",
        "base_type": "activity",
        "properties": {
          "conditions": [],
          "continue_on_failure": false,
          "description": "If-Else condition block",
          "display_name": "Enough free flash?",
          "skip_execution": false
        },
        "object_type": "definition_activity",
        "blocks": [
          {
            "unique_name": "definition_activity_02P2UVAOCU9G51mKGjLEzmU3C2PKMEmGWb9",
            "name": "Condition Branch",
            "title": "Enough free space",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "$activity.definition_activity_02P2UE59JBJ8I4LpYhoREmr6uBPySVyV3nb.output.script_queries.free_space$",
                "operator": "mregex",
                "right_operand": "^(?:1[3-9]\\d{8,}|[2-9]\\d{9,}|\\d{11,})$"
              },
              "continue_on_failure": false,
              "display_name": "Enough free space",
              "skip_execution": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_02SXTYN2NSBVD6eSnoPig4ScoQIn8e9BPN2",
                "name": "Set Variables",
                "title": "Set Variables",
                "type": "core.set_multiple_variables",
                "base_type": "activity",
                "properties": {
                  "continue_on_failure": false,
                  "description": "Set Variables",
                  "display_name": "Set Variables",
                  "skip_execution": false,
                  "variables_to_update": [
                    {
                      "variable_to_update": "$workflow.definition_workflow_02P2TQOB7DX6K3gAgOuYpTjybvDO9rat6So.output.variable_workflow_02SXTYY8AQAGT2NbeV2eGxFHZ1QU1qdOgfK$",
                      "variable_value_new": true
                    },
                    {
                      "variable_to_update": "$workflow.definition_workflow_02P2TQOB7DX6K3gAgOuYpTjybvDO9rat6So.output.workflow_results$",
                      "variable_value_new": "true"
                    }
                  ]
                },
                "object_type": "definition_activity"
              },
              {
                "unique_name": "definition_activity_02SYQM9YYKBQX4fwiZReiVkIC2ho4aIcFi7",
                "name": "Execute Terminal Command(s)",
                "title": "SEND LOG PREFLIGHT PASSED",
                "type": "terminal.command",
                "base_type": "activity",
                "properties": {
                  "action_timeout": 180,
                  "command_timeout": 60,
                  "commands": "term len 0\nsend log 6 \"PRE-FLIGHT: Enough Free Space Starting Upgrade\"",
                  "continue_on_failure": false,
                  "description": "Executes commands on terminal target",
                  "display_name": "SEND LOG PREFLIGHT PASSED",
                  "merge_commands": false,
                  "runtime_user": {
                    "target_default": true
                  },
                  "skip_execution": false,
                  "target": {
                    "use_workflow_target": true
                  },
                  "user_responses": []
                },
                "object_type": "definition_activity"
              }
            ]
          },
          {
            "unique_name": "definition_activity_02P2UVAP9EFEO13qyAsnbzq2HDORoxiBjIa",
            "name": "Condition Branch",
            "title": "Not enough free space",
            "type": "logic.condition_block",
            "base_type": "activity",
            "properties": {
              "condition": {
                "left_operand": "$activity.definition_activity_02P2UE59JBJ8I4LpYhoREmr6uBPySVyV3nb.output.script_queries.free_space$",
                "operator": "mregex",
                "right_operand": "^(?:\\d{1,9}|1[0-2]\\d{8})$"
              },
              "continue_on_failure": false,
              "display_name": "Not enough free space",
              "skip_execution": false
            },
            "object_type": "definition_activity",
            "actions": [
              {
                "unique_name": "definition_activity_02P2UXLGTUD164X81O4ngA8FtD4vXBXc8Ws",
                "name": "Set Variables",
                "title": "Set Variables",
                "type": "core.set_multiple_variables",
                "base_type": "activity",
                "properties": {
                  "continue_on_failure": false,
                  "description": "Set Variables",
                  "display_name": "Set Variables",
                  "skip_execution": false,
                  "variables_to_update": [
                    {
                      "variable_to_update": "$workflow.definition_workflow_02P2TQOB7DX6K3gAgOuYpTjybvDO9rat6So.output.variable_workflow_02P2UXFINIHWG1FsBmZu85dGEZ8558ActwC$",
                      "variable_value_new": "$activity.definition_activity_02P2UKEYQS5KE5dbRsEHZSFN3nfLjyQVI6Y.output.response_body$"
                    }
                  ]
                },
                "object_type": "definition_activity"
              },
              {
                "unique_name": "definition_activity_02SYQN4VON0276pmikYBGq3q5LDL0yDu6yy",
                "name": "Execute Terminal Command(s)",
                "title": "SEND LOG PREFLIGHT FAILED",
                "type": "terminal.command",
                "base_type": "activity",
                "properties": {
                  "action_timeout": 180,
                  "command_timeout": 60,
                  "commands": "term len 0\nsend log 6 \"PRE-FLIGHT: Not Enough Free Space Upgrade Halted\"",
                  "continue_on_failure": false,
                  "description": "Executes commands on terminal target",
                  "display_name": "SEND LOG PREFLIGHT FAILED",
                  "merge_commands": false,
                  "runtime_user": {
                    "target_default": true
                  },
                  "skip_execution": false,
                  "target": {
                    "use_workflow_target": true
                  },
                  "user_responses": []
                },
                "object_type": "definition_activity"
              }
            ]
          }
        ]
      }
    ],
    "categories": [
      "category_1BMfMXSnJMyt5Ihqi7rWJr5N8cf"
    ]
  },
  "targets": {
    "definition_target_02SXP7C95Y9J56IqyjHnR9YXHNH0U2TzxXX": {
      "unique_name": "definition_target_02SXP7C95Y9J56IqyjHnR9YXHNH0U2TzxXX",
      "name": "Lab Router",
      "title": "Lab Router",
      "type": "terminal.endpoint",
      "base_type": "target",
      "object_type": "definition_target",
      "properties": {
        "ao_remote_id": "02QRCDUNN5EP57Lujs3OVleizRjKjeWIk7C",
        "default_runtime_user_id": "definition_runtime_user_02SXOXFRCU81P0vnYr3CyRg0mx5tw5WuSWk",
        "display_name": "Lab Router",
        "host": "10.230.255.20",
        "port": 22,
        "protocol": "ssh"
      }
    }
  },
  "runtime_users": {
    "definition_runtime_user_02SXOXFRCU81P0vnYr3CyRg0mx5tw5WuSWk": {
      "unique_name": "definition_runtime_user_02SXOXFRCU81P0vnYr3CyRg0mx5tw5WuSWk",
      "name": "Local SSH Password",
      "title": "Local SSH Password",
      "type": "runtime_user.terminal_password_credentials",
      "base_type": "runtime_user",
      "object_type": "definition_runtime_user",
      "properties": {
        "display_name": "Local SSH Password",
        "password": "*****",
        "user": "josh"
      }
    }
  },
  "remotemetas": {
    "remote_meta_02QRCDUO490GT54DMFvpHjpjv5WuGFNYvBe": {
      "base_type": "remote_meta",
      "type": "generic.remote_meta",
      "name": "Home-Lab",
      "title": "Home-Lab",
      "version": "1.0.0",
      "properties": {
        "advanced": {
          "remote_cluster_subnet": "10.42.0.0/16",
          "remote_service_subnet": "10.43.0.0/16",
          "require_advanced": true
        },
        "cloud_type": "vmware",
        "display_name": "Home-Lab",
        "network": {
          "is_dhcp": true
        },
        "proxy": {
          "require_proxy": false
        }
      },
      "unique_name": "remote_meta_02QRCDUO490GT54DMFvpHjpjv5WuGFNYvBe",
      "object_type": "remote_meta"
    }
  }
}